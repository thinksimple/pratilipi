<dom-module id="pratilipi-card-mini">

	<style>
		:host {
			display: inline-block;
			text-align:center;
			margin-bottom: 16px;
		}
		.pratilipi-card {
			border-top: 1px solid #d3d3d3;
			display: flex;
		}
		.pratilipi-card .pratilipi-title {
			font-weight: 700;
		}
		.pratilipi-card .pratilipi-title-mini {
			margin-bottom: 12px;
		}
		.pratilipi-card iron-image {
			position: absolute;
			z-index: 0;
			display: block;
			width: inherit;
			height: inherit;
		}
		.pratilipi-card paper-fab.library-icon {
			position: absolute;
			width: 24px;
			height: 24px;
			--paper-fab-background: #F5F5F5;
			opacity: 0.8;
			padding: 0;
			--paper-fab-iron-icon: {
				color: #333;
				width: 15px;
				height: 15px;
			};
		}
		.pratilipi-card paper-fab.share-icon {
			position: absolute;
			width: 24px;
			height: 24px;
			--paper-fab-background: #F5F5F5;
			opacity: 0.75;
			padding: 0;
			--paper-fab-iron-icon: {
				color: #333;
				width: 15px;
				height: 15px;
			};
		}
		.pratilipi-card paper-fab.edit-icon {
			position: absolute;
			width: 22px;
			height: 22px;
			z-index: 1;
			--paper-fab-background: transparent;
			padding: 0;
			--paper-fab-iron-icon: {
				color: #333;
				width: 15px;
				height: 15px;
			};
		}
		.pratilipi-card .centered-div {
			align-self: center;
			margin: auto;
			padding-left: 8px;
			padding-right: 8px;
		}
		.pratilipi-card .centered-div h6 {
			margin: 0;
			margin-bottom: 8px;
			font-size: 14px;
			line-height: 18px;
			font-weight: 500;
		}
		.pratilipi-card .centered-div button {
			display: block;
			cursor: pointer;
			margin: 4px auto;
			font-size: 12px;
		}
		.pratilipi-card .centered-div .btn {
			white-space: normal;
			border-radius: 4px;
			outline: none;
		}
		.pratilipi-card paper-icon-button.close-button {
			position: absolute;
			top: 1px;
		}
		.ellipsed, a.ellipsed:hover, a.ellipsed:focus {
			text-align: left;
			color: #000;
			display: block;
		}
		.white-snippet, .white-snippet-reduced {
			text-decoration: none;
			float: left;
			width: inherit;
			text-align: center;
			color: #333;
			position: relative;
			z-index: 0;
			background: #fbfbfb;
			background: -moz-linear-gradient(to bottom, rgba(255, 255, 255, 0.65) 0%, #fbfbfb 100%);
			background: -webkit-linear-gradient(top, rgba(255, 255, 255, 0.65) 0%, #fbfbfb 100%);
			background: -o-linear-gradient(top, rgba(255, 255, 255, 0.65) 0%, #fbfbfb 100%);
			background: -ms-linear-gradient(top, rgba(255, 255, 255, 0.65) 0%, #fbfbfb 100%);
			background: linear-gradient(to bottom, rgba(255, 255, 255, 0.65) 0%, #fbfbfb 100%);
		}
		.white-snippet {
			height: 60px;
			padding: 4px 8px;
		}
		.white-snippet-reduced {
			height: 45px;
			padding: 8px;
		}
		.meta-container {
			color: #7e7e7e;
			text-align: left;
			background: #fbfbfb;
			position: relative;
		}
		.read-rating-count iron-icon {
			width: 15px; 
			height: 15px;
			margin-top: -2px;
		}
		.share-popup a.share-menu-item {
			color: inherit;
			margin:32px 16px;
			display: block;
			text-align: left;
		}
		.share-popup a.share-menu-item img {
			margin-right: 12px;
			width: 20px;
			height: 20px;
		}
		.share-popup a.share-menu-item span {
			font-size: 15px;
		}
		.library-popup .library-item-menu {
			padding: 30px 4px;
			padding-top: 64px;
		}
		.library-popup .library-item-menu h6 {
			float: left;
		}
		.library-popup .library-item-menu paper-toggle-button {
			--paper-toggle-button-checked-bar-color:  #107fe5;
			--paper-toggle-button-checked-button-color:  #107fe5;
			--paper-toggle-button-checked-ink-color: #107fe5;
			--paper-toggle-button-unchecked-bar-color:  #d0021b;
			--paper-toggle-button-unchecked-button-color:  #d0021b;
			--paper-toggle-button-unchecked-ink-color: #d0021b;
		}

		@media only screen and (max-width: 599px) {
			:host {
				width: 110px;
			}
			.pratilipi-card {
				width: 110px;	
				height: 165px;
			}
			.pratilipi-card .pratilipi-title {
				font-size: 11px;
				line-height: 13px;
			}
			.pratilipi-card paper-fab.library-icon {
				top: 8px;
				margin-left: 4px;
			}
			.pratilipi-card paper-fab.share-icon {
				top: 8px;
				margin-left: 83px;
			}
			.pratilipi-card paper-fab.edit-icon {
				top: 104px;
				margin-left: 85px;
			}
			.pratilipi-card .centered-div button {
				word-break: break-all;
			}
			.white-snippet {
				margin-top: calc( 165px - 60px - 24px );
			}
			.white-snippet-reduced {
				margin-top: calc( 165px - 45px - 24px );
			}
			.meta-container {
				height: 28px;
				margin-top: -27px;
			}
			.ellipsed, a.ellipsed:hover, a.ellipsed:focus {
				width: 80px;
			}
			.read-rating-count {
				font-size: 12px;
			}
			.pratilipi-card paper-icon-button.close-button {
				top: 0px;
				margin-left: 82px;
				height: 32px;
				width: 32px;
			}
		}
		@media only screen and (min-width: 600px) {
			:host {				
				width: 160px;		
			}
			.pratilipi-card {
				width: 160px;
				height: 240px;
			}
			.pratilipi-card .pratilipi-title {
				font-size: 13px;
				line-height: 20px;
			}
			.pratilipi-card paper-fab.library-icon {
				top: 10px;
				margin-left: 4px;
			}
			.pratilipi-card paper-fab.share-icon {
				top: 10px;
				margin-left: 132px;
			}
			.pratilipi-card paper-fab.edit-icon {
				top: 184px;
				margin-left: 132px;
			}
			.pratilipi-card .centered-div button {
				word-break: normal;
			}
			.white-snippet {
				margin-top: calc( 240px - 60px - 20px );
			}
			.white-snippet-reduced {
				margin-top: calc( 240px - 45px - 20px );
			}
			.meta-container {
				height: 24px;
				margin-top: -23px;
			}
			.ellipsed, a.ellipsed:hover, a.ellipsed:focus {
				width: 120px;
			}
			.read-rating-count {
				font-size: 14px;
			}
			.pratilipi-card paper-icon-button.close-button {
				margin-left: 124px;
			}
		}
	</style>


	<template>
		<div class="pratilipi-shadow">
			<template is="dom-if" if="{{ showContent }}">
				<a href="{{ pratilipi.pageUrl }}">
					<span class="pratilipi-card" style="cursor: pointer;" title="{{ fullTitle }}">
						<#-- Image -->
						<iron-image class="pratilipi-shadow" 
										style="background-color: #f5f5f5" 
										fade preload
										sizing="contain" 
										src="{{ pratilipiCoverImage }}" 
										alt="{{ pratilipi.title }}" 
										title="{{ pratilipi.title }}"></iron-image>
						<#-- Icons -->
						<template is="dom-if" if="{{ showShareAndLibraryOptions }}">
							<paper-fab mini class="library-icon" icon="icons:book" on-click="openLibraryDialog"></paper-fab>
							<paper-fab mini class="share-icon" icon="social:share" on-click="openShareDialog"></paper-fab>
						</template>
						<template is="dom-if" if="{{ showEditOption }}">
							<paper-fab mini class="edit-icon" icon="icons:create" on-click="showEditFunction"></paper-fab>
						</template>
						<#-- Case : Author exists -->
						<template is="dom-if" if="{{ pratilipi.author }}">
							<div class="white-snippet">
								<div class="contain-title ellipsed pratilipi-title">{{ title }}</div>
								<a href="{{ pratilipi.author.pageUrl }}"><span class="contain-title ellipsed">{{ pratilipi.author.name }}</span></a>
							</div>
						</template>
						<#-- Case : Author doesn't exist -->
						<template is="dom-if" if="{{ !pratilipi.author }}">
							<div class="white-snippet-reduced">
								<div class="contain-title ellipsed pratilipi-title">{{ title }}</div>
							</div>
						</template>
					</span>
				</a>
			</template>
			<template is="dom-if" if="{{ showEditContent }}">
				<div style="background: #fbfbfb;" class="pratilipi-card">
					<paper-icon-button class="close-button" icon="icons:close" on-click="cancelEditFunction"></paper-icon-button>
					<div class="centered-div">
						<div class="pratilipi-title pratilipi-title-mini">{{ fullTitle }}</div>
						<template is="dom-if" if="{{ canMoveToDrafts }}">
							<button class="btn btn-primary" on-click="confirmMoveContentToDrafts">${ _strings.pratilipi_move_to_drafts }</button>
						</template>
						<template is="dom-if" if="{{ canPublish }}">
							<button class="btn btn-success" on-click="publishContent">${ _strings.pratilipi_publish_it }</button>
						</template>
						<template is="dom-if" if="{{ canDelete }}">
							<button class="btn btn-danger" on-click="confirmDeleteContent">${ _strings.pratilipi_delete_content }</button>
						</template>
					</div>
				</div>
			</template>
			<template is="dom-if" if="{{ showDraftsContent }}">
				<div style="background: #fbfbfb;" class="pratilipi-card">
					<paper-icon-button class="close-button" icon="icons:close" on-click="cancelEditFunction"></paper-icon-button>
					<div class="centered-div">
						<div class="pratilipi-title pratilipi-title-mini">{{ fullTitle }}</div>
						<h6>${ _strings.pratilipi_confirm_move_to_drafts }</h6>
						<button class="btn btn-danger" on-click="moveContentToDrafts">${ _strings.pratilipi_confirm_move_to_drafts_okay }</button>
					</div>
				</div>
			</template>
			<template is="dom-if" if="{{ showDeleteContent }}">
				<div style="background: #fbfbfb;" class="pratilipi-card">
					<paper-icon-button class="close-button" icon="icons:close" on-click="cancelEditFunction"></paper-icon-button>
					<div class="centered-div">
						<div class="pratilipi-title pratilipi-title-mini">{{ fullTitle }}</div>
						<h6>${ _strings.pratilipi_confirm_delete_content }</h6>
						<button class="btn btn-danger" on-click="deleteContent">${ _strings.pratilipi_confirm_delete_content_okay }</button>
					</div>
				</div>
			</template>

			<div class="meta-container">
				<span class="read-rating-count pull-left" style="margin-left: 8px;">
					<iron-icon icon="icons:chrome-reader-mode"></iron-icon>
					{{ readText }}
				</span>
				<template is="dom-if" if="{{ showRating }}">
					<span class="read-rating-count pull-right" style="margin-right: 8px;">
						{{ averageRating }}
						<iron-icon icon="icons:star"></iron-icon>
					</span>
				</template>
			</div>
		</div>
		<#-- Share Modal -->
		<div class="modal fade share-popup" tabindex="-1">
			<div class="modal-dialog" width="400px;">
				<div class="modal-content">
					<div class="modal-body">
						<paper-icon-button class="pull-right" icon="icons:close" data-dismiss="modal"></paper-icon-button>
						<div class="text-center">
							<a class="share-menu-item" on-click="shareOnFacebook">
								<span class="icon icon-facebook"></span>
								<span>${ _strings.share_on_facebook }</span>
							</a>
							<a class="share-menu-item" on-click="shareOnTwitter">
								<span class="icon icon-twitter"></span>
								<span>${ _strings.share_on_twitter }</span>
							</a>
							<a class="share-menu-item" on-click="shareOnGplus">
								<span class="icon icon-google-plus"></span>
								<span>${ _strings.share_on_gplus }</span>
							</a>
						</div>
					</div>
				</div>
			</div>
		</div>
		<#-- Library Modal -->
		<div class="modal fade library-popup" tabindex="-1">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-body">
						<paper-icon-button class="pull-right" icon="icons:close" data-dismiss="modal"></paper-icon-button>
						<div class="library-item-menu">
							<h6>${ _strings.library_content_in_library }</h6>
							<paper-toggle-button noink class="pull-right" checked="{{ addedToLib }}" on-change="switchLibraryState"></paper-toggle-button>
						</div>
					</div>
				</div>
			</div>
		</div>
		<iron-ajax
				id="UserPratilipiLibraryApi"
				url="/api/userpratilipi/library"
				method="POST"
				content-type="application/x-www-form-urlencoded"
				handle-as="json"
				on-response="_userPratilipiLibraryApiResponse"
				on-error="_userPratilipiLibraryApiError"
				></iron-ajax>
	</template>


	<script>
		Polymer({

			is: 'pratilipi-card-mini',

			properties: {
				pratilipi: { type: Object, observer: "_pratilipiObserver" },
				state: { type: String, observer: "_stateObserver" },
				showEditOption: { type: Boolean, value: false },

				showContent: { type: Boolean, value: true },
				showEditContent: { type: Boolean, value: false },
				showDraftsContent: { type: Boolean, value: false },
				showDeleteContent: { type: Boolean, value: false },

				shareDialogOpened: { type: Boolean, value: false },
				libraryDialogOpened: { type: Boolean, value: false }
			},
			
			_stateObserver: function() {
				this.set( 'canMoveToDrafts', this.state != "DRAFTED" );
				this.set( 'canPublish', this.state != "PUBLISHED" );
				this.set( 'canDelete', this.state != "DELETED" && this.state != "PUBLISHED" );
			},

			_pratilipiObserver: function() {
				if( this.pratilipi.title != null && this.pratilipi.title.trim() != "" && this.pratilipi.titleEn != null && this.pratilipi.titleEn.trim() != null )
					this.set( 'fullTitle', this.pratilipi.title + " | " + this.pratilipi.titleEn );
				else if( this.pratilipi.title != null && this.pratilipi.title.trim() != "" )
					this.set( 'fullTitle', this.pratilipi.title );
				else
					this.set( 'fullTitle', this.pratilipi.titleEn );
				this.set( 'title', this.pratilipi.title != null && this.pratilipi.title.trim() != "" ? this.pratilipi.title : this.pratilipi.titleEn );
				var width = jQuery( window ).width() >= 600 ? "160" : "110";
				this.set( 'pratilipiCoverImage', this.pratilipi.coverImageUrl + ( this.pratilipi.coverImageUrl.indexOf( '?' ) == -1 ? "?" : "&" ) + "width=" + width );
				this.set( 'averageRating', Math.round( this.pratilipi.averageRating * 10 ) / 10 );
				this.set( 'readText', abbrNum( this.pratilipi.readCount, 1 ) );
				this.set( 'showRating', this.pratilipi.averageRating > 0 );
				this.set( 'hasAccessToUpdate', this.pratilipi.hasAccessToUpdate );
				this.set( 'showEditOption', this.pratilipi.hasAccessToUpdate && this.showEditOption );
				this.set( 'showShareAndLibraryOptions', this.state != "DRAFTED" );
				this.set( 'addedToLib', this.pratilipi.addedToLib );
			},

			redirectToContentPage: function() {
				if( this.shareDialogOpened ) {
					this.set( 'shareDialogOpened', false );
					return;
				}
				if( this.libraryDialogOpened ) {
					this.set( 'libraryDialogOpened', false );
					return;
				}
				if( this.showEditContent )
					return;

				window.location.href = this.pratilipi.pageUrl;
			},

			showEditFunction: function( e ) {
				e.preventDefault();
				e.stopPropagation();
				this.set( 'showContent', false );
				this.set( 'showEditContent', true );
			},

			cancelEditFunction: function() {
				this.set( 'showEditContent', false );
				this.set( 'showDraftsContent', false );
				this.set( 'showDeleteContent', false );
				this.set( 'showContent', true );
			},

			confirmMoveContentToDrafts: function() {
				this.set( 'showEditContent', false );
				this.set( 'showDraftsContent', true );
			},

			confirmDeleteContent: function() {
				this.set( 'showEditContent', false );
				this.set( 'showDeleteContent', true );
			},

			moveContentToDrafts: function() {
				this.domHost.moveContentToDrafts( this.pratilipi.pratilipiId );
			},

			publishContent: function() {
				this.domHost.publishContent( this.pratilipi.pratilipiId );
			},

			deleteContent: function() {
				this.domHost.deleteContent( this.pratilipi.pratilipiId );
			},

			openShareDialog: function( e ) {
				e.preventDefault();
				e.stopPropagation();
				this.set( 'shareDialogOpened', true );
				jQuery( this.querySelector( '.share-popup' ) ).modal();
			},

			openLibraryDialog: function( e ) {
				e.preventDefault();
				e.stopPropagation();
				this.set( 'libraryDialogOpened', true );
				jQuery( this.querySelector( '.library-popup' ) ).modal();
			},

			_getShareUrl: function( utm_source ) {
				if( utm_source == null ) return;
				var utm_parent = "pratilipi";
				if( document.querySelector( 'pratilipi-author-page' ) != null )
					utm_parent = "profile";
				else if( document.querySelector( 'pratilipi-event-page' ) != null )
					utm_parent = "event";
				else if( document.querySelector( 'pratilipi-library-page' ) != null )
					utm_parent = "library";
				var width = window.innerWidth || document.documentElement.clientWidth || document.body.clientWidth;
				return encodeURIComponent( 
						"http://${ domain }" + this.pratilipi.pageUrl 
						+ ( this.pratilipi.pageUrl.indexOf( '?' ) == -1 ? "?" : "&" )
						+ "utm_language=${ language?lower_case }" + "&"
						+ "utm_version=standard" + "&"
						+ "utm_device=" + ( width < 600 ? "mobile" : "desktop" ) + "&"
						+ "utm_parent=" + utm_parent + "&"
						+ "utm_location=card" + "&"
						+ "utm_action=share" + "&"
						+ "utm_source=" + utm_source
					);
			},

			shareOnFacebook: function() {
				clevertapShareContentOnFacebook( this.pratilipi.title, this.pratilipi.pratilipiId );
				window.open( "http://www.facebook.com/sharer.php?u=" + this._getShareUrl( "facebook" ), 
						"share", "width=1100,height=500,left=70px,top=60px" );
			},

			shareOnTwitter: function() {
				window.open( "http://twitter.com/share?url=" + this._getShareUrl( "twitter" ), 
						"share", "width=1100,height=500,left=70px,top=60px" );
			},

			shareOnGplus: function() {
				window.open( "https://plus.google.com/share?url=" + this._getShareUrl( "gplus" ), 
						"share", "width=1100,height=500,left=70px,top=60px" );
			},

			switchLibraryState: function() {
				if( document.querySelector( 'pratilipi-user' ).getCurrentUser().isGuest ) {
					this.async( function() {
						this.set( 'addedToLib', ! this.addedToLib );
					}, 120 );
					this.async( function() {
						jQuery( this.querySelector( '.library-popup' ) ).modal( 'hide' );
						document.querySelector( 'pratilipi-user' ).logIn( true, "${ _strings.user_login_to_view_library }" );
					}, 250 );
					return;
				}
				this.$.UserPratilipiLibraryApi.body = ( "pratilipiId=" + this.pratilipi.pratilipiId + "&" + "addedToLib=" + this.addedToLib );
				this.$.UserPratilipiLibraryApi.generateRequest();
			},
			
			_userPratilipiLibraryApiResponse: function( response ) {
				if( this.addedToLib != response.detail.response.addedToLib )
					this.set( 'addedToLib', response.detail.response.addedToLib );
			},
			
			_userPratilipiLibraryApiError: function( response ) {
				this.set( 'addedToLib', ! this.addedToLib );
			}

		});

	</script>

</dom-module>