<dom-module id="pratilipi-notification-settings">

	<style>

		:host {
			display: block;
		}
		
		paper-dropdown-menu.pratilipi-blue {
			width: 100%;
			--paper-dropdown-menu-focus-color: #107fe5;
			--paper-dropdown-menu-input-color: #107fe5;
			--primary-text-color: #107fe5;
			--paper-input-container: {
				color: #107fe5;
			};
			--paper-input-container-input: {
				font-family: inherit;
				color: #333;
			};
			--paper-input-container-underline: {
				background: #333;
				color: #333;
			};
			--paper-input-container-label: {
				font-size: 15px;
				font-family: inherit;
				text-align: left;
				color: #333;
			};
			--paper-input-container-focus:{
				color: #333;
			};
		}
		
		paper-menu {
			--paper-menu-color: #333;
			width: 100%;
			--paper-menu-focused-item: {
				color: #333;
			};
			--paper-item-focused-before: {
				color: #333;
				background: #fff;
			};
		}
		
		paper-menu paper-item {
			font-size: 15px;
			font-family: inherit;
			color: #333;
			white-space: nowrap;
		}
		
		paper-checkbox.pratilipi-red {
			align-self: center;
			--paper-checkbox-checked-color: #107fe5;
			--paper-checkbox-checked-ink-color: #333;
			--paper-checkbox-unchecked-color: #333;
			--paper-checkbox-unchecked-ink-color: #333;
			--paper-checkbox-label-color: #333;
			--paper-checkbox-label-spacing: 0;
			--paper-checkbox-margin: 0 8px 8px 0;
			--paper-checkbox-vertical-align: top;
		}
		
		.settings-group {
			padding-top: 20px;
		}
		.settings-group h6 {
			color: #000;
		}
		paper-spinner.new-spinner {
			position: absolute;
			top: 0;
			left: 0;
			right: 0;
			bottom: 0;
			margin: auto;
			--paper-spinner-layer-1-color: #D0021B;
			--paper-spinner-layer-2-color: #107FE5;
			--paper-spinner-layer-3-color: #D0021B;
			--paper-spinner-layer-4-color: #107FE5;
		}
		
		.row {padding-left: 10px;padding-right: 10px;}
		.modal-body{padding-bottom: 0;}
		.modal-content {border-radius: 0;}
		.pull-center {display:block;margin-left:auto;margin-right:auto;text-align:center;}

	</style>

	<template>
		<div class="modal fade" id="pratilipiNotificationSettings" role="dialog" tabindex="-1">
			<div class="modal-dialog" role="document">
				<div class="modal-content">
					<div class="modal-header">
						<button style="opacity: 1; outline: none;" type="button" class="close" data-dismiss="modal" aria-label="Close"><iron-icon style="color: #333;" icon="icons:close"></iron-icon></button>
						<h6 style="min-height: 20px; line-height: 20px;" class="modal-title">
							${ _strings.notification_settings }
						</h6>
					</div>
					<div class="modal-body">
							<paper-spinner class="new-spinner" active="{{ spinnerActive }}"></paper-spinner>
							<paper-dropdown-menu id="selectEmailFrequency" noink label="${ _strings.email_frequency }" vertical-align="top" horizontal-align="right" class="pratilipi-blue">
								<paper-menu selected="{{ selectedEmailFrequency }}"  noink class="dropdown-content" style="white-space: nowrap; width: auto;">
									<paper-item value="IMMEDIATELY">${ _strings.email_frequency_immediate }</paper-item>
									<paper-item value="DAILY">${ _strings.email_frequency_daily }</paper-item>
									<paper-item value="WEEKLY">${ _strings.email_frequency_weekly }</paper-item>
									<paper-item value="MONTHLY">${ _strings.email_frequency_monthly }</paper-item>
									<paper-item value="NEVER">${ _strings.email_frequency_never }</paper-item>
								</paper-menu>
							</paper-dropdown-menu>
							<div class="settings-group">
								<h6>${ _strings.notification_group_content }</h6>
								<div class="row">
									<div class="col-xs-12 col-sm-12 col-md-12 col-lg-6">
										<paper-checkbox value="USER_PRATILIPI_REVIEW" class="pratilipi-red" noink>${ _strings.option_new_review }</paper-checkbox>
									</div>
									<div class="col-xs-12 col-sm-12 col-md-12 col-lg-6">
										<paper-checkbox value="COMMENT_REVIEW_REVIEWER" class="pratilipi-red" noink>${ _strings.option_new_comment }</paper-checkbox>
									</div>
									<div class="col-xs-12 col-sm-12 col-md-12 col-lg-6">
										<paper-checkbox value="VOTE_REVIEW_REVIEWER" class="pratilipi-red" noink>${ _strings.option_like_review }</paper-checkbox>
									</div>
									<div class="col-xs-12 col-sm-12 col-md-12 col-lg-6">
										<paper-checkbox value="VOTE_COMMENT_REVIEW_COMMENTOR" class="pratilipi-red" noink>${ _strings.option_like_comment }</paper-checkbox>
									</div>
								</div>
							</div>
							<div class="settings-group">
								<h6>${ _strings.notification_group_network }</h6>
								<div class="row">
									<div class="col-xs-12 col-sm-12 col-md-12 col-lg-6">
										<paper-checkbox value="AUTHOR_FOLLOW" class="pratilipi-red" noink>${ _strings.option_new_follower }</paper-checkbox>
									</div>
									<div class="col-xs-12 col-sm-12 col-md-12 col-lg-6">
										<paper-checkbox value="PRATILIPI_PUBLISHED_FOLLOWER" class="pratilipi-red" noink>${ _strings.option_pratilipi_published_follower }</paper-checkbox>
									</div>
									<div class="col-xs-12 col-sm-12 col-md-12 col-lg-6">
										<paper-checkbox value="GENERIC" class="pratilipi-red" noink>${ _strings.option_pratilipi_updates }</paper-checkbox>
									</div>
								</div>
							</div>
						<div class="display-message-div pratilipi-red"><p>{{ message }}</p></div>
					</div>
					<div class="modal-footer" style="border: none; padding-top: 0px;">
						<button disabled="{{ !canSaveChanges }}" id="notificationSettingsButton" class="pratilipi-dark-blue-button" type="button" on-click="onSubmit">
							${ _strings.notification_settings_save_changes }
						</button>
					</div>
				</div>
			</div>
		</div>
	</template>

	<script>

		function firebaseCallback( preferences ) {
			document.querySelector( 'pratilipi-notification-settings' ).firebaseCallback( preferences );
		}

		Polymer({

			is: 'pratilipi-notification-settings',
			
			properties: {
				selectedEmailFrequency: { type: Number },
				message: { type: String },
				canSaveChanges: { type: Boolean }
			},

			stopUserInteraction: function() {
				// Enable spinner and disable button
				this.set( 'canSaveChanges', false );
				this.set( 'spinnerActive', true );
			},

			resumeUserInteration: function() {
				// Enable button and disable spinner
				this.set( 'canSaveChanges', true );
				this.set( 'spinnerActive', false );
			},

			open: function() {
				jQuery( "#pratilipiNotificationSettings" ).modal();
				this.stopUserInteraction();
				getNotificationPreferences( firebaseCallback );
			},

			close: function() {
				jQuery( "#pratilipiNotificationSettings" ).modal( 'hide' );
			},

			firebaseCallback: function( preferences ) {

				var emailFrequency = preferences[ "emailFrequency" ] != null ? preferences[ "emailFrequency" ] : "IMMEDIATELY";
				var i = 0;
				$( "pratilipi-notification-settings #selectEmailFrequency paper-menu paper-item" ).each( function() {
					if( $( this ).attr( "value" ) === emailFrequency ) {
						return false;
					} i++;
				});
				this.set( 'selectedEmailFrequency', i );

				var notificationSubscriptions = preferences[ "notificationSubscriptions" ] != null ? 
						preferences[ "notificationSubscriptions" ] : {};
				$( "pratilipi-notification-settings #pratilipiNotificationSettings paper-checkbox" ).each( function() {
					$( this ).prop( 'checked', notificationSubscriptions[ $( this ).val() ] != null ?
							notificationSubscriptions[ $( this ).val() ] : true );
				});

				this.resumeUserInteration();

			},

			onSubmit: function() {

				var preferences = {};
				preferences[ "emailFrequency" ] = this.$.selectEmailFrequency.selectedItem.getAttribute( "value" );
				preferences[ "notificationSubscriptions" ] = {};

				$( "pratilipi-notification-settings #pratilipiNotificationSettings paper-checkbox" ).each( function() {
					preferences[ "notificationSubscriptions" ][ $( this ).val() ] = this.checked;
				});

				this.stopUserInteraction();
				setNotificationPreferences( preferences );

				// Feedback here
				this.set( "message", "${ _strings.success_generic_message }" );
				this.async( function() {
					this.resumeUserInteration();
					this.set( "message", null );
					this.close();
				}, 1000 );
			}

		});

	</script>

</dom-module>
